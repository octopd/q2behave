FROM node:14-alpine

ARG DB_HOST=""
ARG DB_USER=""
ARG DB_PASSWORD=""
ARG DB_NAME=""
ARG DB_DRIVER=""
ARG NODEMAILER_USER=""
ARG NODEMAILER_PASSWORD=""
ARG DOMAIN=""
ARG JWT_SECRET=""

ENV DB_HOST=$DB_HOST
ENV DB_USER=$DB_USER
ENV DB_PASSWORD=$DB_PASSWORD
ENV DB_NAME=$DB_NAME
ENV DB_DRIVER=$DB_DRIVER
ENV NODEMAILER_USER=$NODEMAILER_USER
ENV NODEMAILER_PASSWORD=$NODEMAILER_PASSWORD
ENV DOMAIN=$DOMAIN
ENV JWT_SECRET=$JWT_SECRET

ENV NODE_ENV=production
ENV PORT=80

COPY package*.json yarn* ./

RUN apk add --no-cache git
RUN yarn install --frozen-lockfile --production

COPY . .

RUN  yarn build

EXPOSE 80

# TODO: PM2
CMD [ "node", "dist/server.js" ]